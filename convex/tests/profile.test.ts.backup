import { describe, it, expect, beforeEach, vi } from "vitest";
import { convexTest } from "convex-test";
import schema from "../schema";
import { api } from "../../convex/_generated/api";
import { internal } from "../../convex/_generated/api";

describe("profile functions", () => {
	const t = convexTest(schema);

	describe("getCurrentUserProfile", () => {
		it("returns null when user is not authenticated", async () => {
			const result = await t.run(api.profile.getCurrentUserProfile);
			expect(result).toEqual({
				user: null,
				workOsIdentity: null,
				memberships: [],
				activeOrganizationId: null,
			});
		});

		it("returns user profile when authenticated", async () => {
			// Setup mock user
			await t.db.insert("users", {
				idp_id: "user_123",
				email: "test@example.com",
				email_verified: true,
				first_name: "John",
				last_name: "Doe",
				profile_picture_url: "https://example.com/avatar.jpg",
			});

			// Mock authentication
			t.auth.setUserIdentity({
				subject: "user_123",
				profile: {
					email: "test@example.com",
					firstName: "John",
					lastName: "Doe",
					profilePictureUrl: "https://example.com/avatar.jpg",
				},
			});

			const result = await t.run(api.profile.getCurrentUserProfile);

			expect(result.user).toBeDefined();
			expect(result.user?.email).toBe("test@example.com");
			expect(result.user?.first_name).toBe("John");
			expect(result.user?.last_name).toBe("Doe");
		});

		it("returns organization memberships", async () => {
			// Setup user
			await t.db.insert("users", {
				idp_id: "user_456",
				email: "user@example.com",
				email_verified: true,
			});

			// Setup organization
			const orgId = await t.db.insert("organizations", {
				id: "org_123",
				name: "Test Org",
			});

			// Setup membership
			await t.db.insert("organization_memberships", {
				id: "member_123",
				user_id: "user_456",
				organization_id: "org_123",
				status: "active",
			});

			// Mock authentication
			t.auth.setUserIdentity({
				subject: "user_456",
			});

			const result = await t.run(api.profile.getCurrentUserProfile);

			expect(result.memberships).toHaveLength(1);
			expect(result.memberships[0]?.organizationId).toBe("org_123");
		});
	});

	describe("updateProfile", () => {
		it("updates user profile fields", async () => {
			// Setup user
			await t.db.insert("users", {
				idp_id: "user_789",
				email: "update@example.com",
				email_verified: true,
				first_name: "Jane",
			});

			// Mock authentication
			t.auth.setUserIdentity({
				subject: "user_789",
			});

			const result = await t.run(api.profile.updateProfile, {
				first_name: "Janet",
				last_name: "Smith",
				phone: "+1234567890",
			});

			expect(result).toEqual({ synced: true });

			const users = await t.db
				.query("users")
				.withIndex("by_idp_id", (q) => q.eq("idp_id", "user_789"))
				.collect();

			expect(users[0]?.first_name).toBe("Janet");
			expect(users[0]?.last_name).toBe("Smith");
			expect(users[0]?.phone).toBe("+1234567890");
		});

		it("throws error when user is not authenticated", async () => {
			await expect(
				t.run(api.profile.updateProfile, {
					first_name: "Test",
				})
			).rejects.toThrow("Unauthenticated");
		});

		it("throws error when user does not exist", async () => {
			// Mock authentication without user in DB
			t.auth.setUserIdentity({
				subject: "nonexistent_user",
			});

			await expect(
				t.run(api.profile.updateProfile, {
					first_name: "Test",
				})
			).rejects.toThrow("User not found");
		});

		it("only updates provided fields", async () => {
			// Setup user
			await t.db.insert("users", {
				idp_id: "user_999",
				email: "partial@example.com",
				email_verified: true,
				first_name: "Original",
				last_name: "Name",
			});

			// Mock authentication
			t.auth.setUserIdentity({
				subject: "user_999",
			});

			await t.run(api.profile.updateProfile, {
				first_name: "Updated",
			});

			const users = await t.db
				.query("users")
				.withIndex("by_idp_id", (q) => q.eq("idp_id", "user_999"))
				.collect();

			expect(users[0]?.first_name).toBe("Updated");
			expect(users[0]?.last_name).toBe("Name"); // Should not change
		});
	});

	describe("setActiveOrganization", () => {
		it("sets active organization for user", async () => {
			// Setup user
			await t.db.insert("users", {
				idp_id: "user_org_123",
				email: "org@example.com",
				email_verified: true,
			});

			// Setup organization
			const orgId = await t.db.insert("organizations", {
				id: "org_active_123",
				name: "Active Org",
			});

			// Setup membership
			await t.db.insert("organization_memberships", {
				id: "member_org_123",
				user_id: "user_org_123",
				organization_id: "org_active_123",
				status: "active",
			});

			// Mock authentication
			t.auth.setUserIdentity({
				subject: "user_org_123",
			});

			await t.run(api.profile.setActiveOrganization, {
				organization_id: "org_active_123",
			});

			const users = await t.db
				.query("users")
				.withIndex("by_idp_id", (q) => q.eq("idp_id", "user_org_123"))
				.collect();

			expect(users[0]?.active_organization_id).toBe("org_active_123");
		});

		it("throws error when user is not a member of organization", async () => {
			// Setup user
			await t.db.insert("users", {
				idp_id: "user_no_member",
				email: "nomember@example.com",
				email_verified: true,
			});

			// Setup organization
			const orgId = await t.db.insert("organizations", {
				id: "org_no_member",
				name: "No Member Org",
			});

			// Mock authentication
			t.auth.setUserIdentity({
				subject: "user_no_member",
			});

			await expect(
				t.run(api.profile.setActiveOrganization, {
					organization_id: "org_no_member",
				})
			).rejects.toThrow("Cannot set organization: not a member");
		});
	});
});
