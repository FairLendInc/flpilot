# Migrate Mock Data to Convex Database Schemas

## Why

The application currently uses mock data generators for listings, payments, and property information. This prevents:
- **Real data persistence**: Changes and transactions cannot be saved
- **User-specific data**: Investors cannot track their own portfolios or deals
- **State management**: Listing locks, deal workflows, and payment tracking require database state
- **Production readiness**: The platform cannot support real mortgages or transactions

Implementing Convex schemas enables the core mortgage marketplace workflows: browsing listings, locking mortgages for purchase, progressing through deal states, tracking ownership, and managing payments.

## What Changes

### New Convex Tables
- **mortgages** - Core loan + property records with embedded property data, borrower reference, and loan details
- **borrowers** - Minimal borrower profiles with Rotessa integration (name, email, Rotessa customer ID)
- **mortgage_ownership** - Cap table for tracking fractional ownership (prepared for future fractional ownership feature)
- **listings** - Marketplace visibility and lock state for mortgages available for purchase
- **appraisal_comparables** - Comparable property data linked to mortgage appraisals
- **payments** - Front-end view of Rotessa payment data (interest-only payments)

### Schema Design Principles
- **YAGNI approach**: Minimal implementation, expand only when needed
- **Loose coupling**: Separate concerns (borrowers, ownership, payments) into distinct tables
- **Extensibility**: Cap table structure prepared for future fractional ownership without implementing it now
- **Embedded data**: Property details embedded in mortgages table (denormalized for simplicity)

### Data Model Relationships
```
mortgages (core entity)
  ├─> borrowers (one-to-one)
  ├─> mortgage_ownership (one-to-many cap table entries)
  ├─> listings (one-to-one, optional - only if listed for sale)
  ├─> appraisal_comparables (one-to-many)
  └─> payments (one-to-many)

mortgage_ownership entries
  └─> users OR "fairlend" string (union type for institutional ownership)
```

### Migration from Mock Data
- Replace `lib/mock-data/listings.ts` usage with Convex queries
- Update listing pages to use real database queries
- Migrate mock data types to Convex schema validators
- Update components to work with Convex reactive queries

## Impact

### Affected Specs
- **NEW**: `mortgages` - Core mortgage and property data storage
- **NEW**: `borrowers` - Borrower profile management
- **NEW**: `mortgage-ownership` - Ownership tracking and cap table
- **NEW**: `listings` - Marketplace listing management
- **NEW**: `appraisal-comparables` - Property valuation comparables
- **NEW**: `payments` - Payment history tracking

### Affected Code

**New Convex functions**:
- `convex/mortgages.ts` - Query/mutation functions for mortgage operations
- `convex/borrowers.ts` - Borrower profile operations
- `convex/ownership.ts` - Ownership cap table management
- `convex/listings.ts` - Listing visibility and lock management
- `convex/comparables.ts` - Appraisal comparable queries
- `convex/payments.ts` - Payment history queries

**Modified files**:
- `convex/schema.ts` - Add all new table definitions
- `app/(auth)/listings/page.tsx` - Replace mock data with Convex queries
- `app/(auth)/listings/[id]/page.tsx` - Use real data from Convex
- Components using `MockListing` type - Update to use generated Convex types

**Generated types**:
- `convex/_generated/dataModel.d.ts` - New table types auto-generated by Convex
- Update imports from mock types to Convex types throughout application

**Mock data files**:
- Keep `lib/mock-data/listings.ts` temporarily for Storybook stories
- Eventually migrate Storybook to use test fixtures instead of mock generators

### Environment Requirements
No new environment variables required - uses existing Convex configuration.

### Breaking Changes
- **Type changes**: `MockListing` type replaced with Convex-generated types
- **Import paths**: Components must import from `convex/_generated/dataModel` instead of mock-data
- **API changes**: Mock generator functions replaced with Convex queries/mutations

### Migration Required
**Data seeding**: Need to populate database with initial mortgage data for development/testing.

### Dependencies
All required dependencies already present:
- `convex` (1.27.3) - Backend database and functions
- `@heroui/react` - UI components (no changes needed)
- No additional packages required

## Implementation Notes

### Ownership Model
- Uses union type: `ownerId: userId | "fairlend"`
- Cap table records link mortgages to owners with fractional percentages
- Prepared for fractional ownership without implementing distribution logic yet
- Each cap table entry: `{ mortgageId, ownerId, ownershipPercentage }`

### Payment Data
- Interest-only payments (no principal/escrow tracking)
- Fields: amount, processDate, paymentId, status (pending/cleared/failed)
- Includes Rotessa identifiers: customerId, transactionScheduleId
- Front-end view only - Rotessa is source of truth

### Document Storage
- Mortgage documents use Convex storage IDs
- Migration required: convert mock URLs to actual uploaded files in Convex storage
- Document fields: name, type, storageId, uploadDate, fileSize

### Renewable Mortgages
- Renewals create new mortgage records
- Link to previous mortgage via `previousMortgageId` field
- Maintains historical chain of renewals
